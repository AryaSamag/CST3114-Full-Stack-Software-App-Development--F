<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CST3144 Lesson Booking System</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-graduation-cap"></i>
                    Lesson Booking System
                </a>
                <div class="navbar-nav">
                    <button class="btn btn-outline" @click="showCart = false">
                        <i class="fas fa-list"></i>
                        Lessons
                    </button>
                    <button class="btn btn-outline cart-btn" @click="showCart = true" :disabled="cartItemCount === 0">
                        <i class="fas fa-shopping-cart"></i>
                        Cart
                        <span v-if="cartItemCount > 0" class="badge">{{ cartItemCount }}</span>
                    </button>
                </div>
            </div>
        </nav>
        <!-- Lessons Page -->
        <div v-if="!showCart" id="lessons-page" class="container page-container">
            <!-- Search and Sort Controls -->
            <div class="controls-row">
                <div class="control-item search-control">
                    <div class="input-group">
                        <span class="input-group-icon"><i class="fas fa-search"></i></span>
                        <input type="text" v-model="searchQuery" class="form-control" placeholder="Search lessons..." @input="performSearch()">
                    </div>
                </div>
                <div class="control-item sort-by-control">
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" v-model="sortBy" value="subject" name="sortBy"> Subject</label>
                        <label class="radio-label"><input type="radio" v-model="sortBy" value="location" name="sortBy"> Location</label>
                        <label class="radio-label"><input type="radio" v-model="sortBy" value="price" name="sortBy"> Price</label>
                        <label class="radio-label"><input type="radio" v-model="sortBy" value="spaces" name="sortBy"> Availability</label>
                    </div>
                </div>
                <div class="control-item sort-order-control">
                    <label class="radio-label"><input type="radio" v-model="sortOrder" value="asc" name="sortOrder"> Ascending</label>
                    <label class="radio-label"><input type="radio" v-model="sortOrder" value="desc" name="sortOrder"> Descending</label>
                </div>
                <div class="control-item results-info">
                    <i class="fas fa-info-circle"></i>
                    <span>{{ sortedLessons.length }}</span> lessons found
                </div>
            </div>
        <!-- Lessons Grid -->
            <div class="lessons-grid">
                <div v-for="lesson in sortedLessons" :key="lesson.id" class="lesson-card">
                    <div class="lesson-icon">
                        <img
                            v-if="!lesson.imageMissing"
                            :src="getImagePath(lesson.subject)"
                            :alt="lesson.subject + ' icon'"
                            @error="onImgError($event, lesson)"
                            class="lesson-img"
                        >
                        <i v-else :class="lesson.icon"></i>
                    </div>
                    <h3>{{ lesson.subject }}</h3>
                    <div class="rating" aria-label="Rating">
                        <i v-for="n in 5" :key="n" :class="n <= lesson.rating ? 'fas fa-star' : 'far fa-star'" aria-hidden="true"></i>
                        <span class="rating-value">{{ lesson.rating.toFixed(1) }}</span>
                    </div>
                    <div class="lesson-info">
                        <i class="fas fa-map-marker-alt"></i> Location: <strong class="lesson-location">{{ lesson.location }}</strong>
                    </div>
                    <div class="price">
                        <i class="fas fa-tag"></i> Price: AED {{ lesson.price }}
                    </div>
                    <div class="lesson-info">
                        <i class="fas fa-users"></i> Availability: 
                        <strong>{{ lesson.spaces }} {{ lesson.spaces === 1 ? 'space' : 'spaces' }}</strong>
                    </div>
                    <button 
                        class="add-btn" 
                        @click="addToCart(lesson)"
                        :disabled="lesson.spaces === 0">
                        <i class="fas fa-cart-plus"></i>
                        {{ lesson.spaces > 0 ? 'Add to Cart' : 'Out of Stock' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Cart View -->
        <div v-else class="cart-view">
            <div class="cart-header">
                <h2><i class="fas fa-shopping-cart"></i> Shopping Cart</h2>
                <button class="back-btn" @click="toggleCart">
                    <i class="fas fa-arrow-left"></i> Back to Lessons
                </button>
            </div>

            <div v-if="cart.length > 0">
                <!-- Cart Items -->
                <div v-for="item in cart" :key="item.id" class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-left">
                            <div class="cart-item-image">
                                <img
                                    v-if="!item.imageMissing"
                                    :src="getImagePath(item.subject)"
                                    :alt="item.subject + ' icon'"
                                    @error="onCartImgError($event, item)"
                                    class="cart-item-img"
                                >
                                <i v-else :class="item.icon"></i>
                            </div>
                            <div class="cart-item-text">
                                <h3>{{ item.subject }}</h3>
                                <div class="cart-item-details">
                                    {{ item.location }} â€¢ AED {{ item.price }} per lesson
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="cart-item-right">
                        <div class="quantity">Qty: {{ item.quantity }}</div>
                        <button class="remove-btn" @click="removeFromCart(item)">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="checkout-section">
                    <h3>Checkout Information</h3>
                    <div class="form-group">
                        <label>First Name *</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.firstName"
                            @input="validateForm"
                            :class="{ error: checkoutForm.firstNameError }"
                            placeholder="Enter your first name">
                        <div v-if="checkoutForm.firstNameError" class="error-message">
                            {{ checkoutForm.firstNameError }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.lastName"
                            @input="validateForm"
                            :class="{ error: checkoutForm.lastNameError }"
                            placeholder="Enter your last name">
                        <div v-if="checkoutForm.lastNameError" class="error-message">
                            {{ checkoutForm.lastNameError }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.address"
                            placeholder="Enter your address">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.city"
                            placeholder="Enter your city">
                    </div>
                    <div class="form-group">
                        <label>State</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.state"
                            placeholder="Enter your state">
                    </div>
                    <div class="form-group">
                        <label>ZIP Code</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.zip"
                            placeholder="Enter your ZIP code">
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.phone"
                            @input="validateForm"
                            :class="{ error: checkoutForm.phoneError }"
                            placeholder="Enter your phone number">
                        <div v-if="checkoutForm.phoneError" class="error-message">
                            {{ checkoutForm.phoneError }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input 
                                type="checkbox" 
                                v-model="checkoutForm.sendGift">
                            Send as a Gift
                        </label>
                    </div>
                    <div v-if="checkoutForm.sendGift" class="form-group">
                        <label>Gift Recipient Phone *</label>
                        <input 
                            type="text" 
                            v-model="checkoutForm.giftPhone"
                            @input="validateForm"
                            :class="{ error: checkoutForm.giftPhoneError }"
                            placeholder="Enter gift recipient's phone number">
                        <div v-if="checkoutForm.giftPhoneError" class="error-message">
                            {{ checkoutForm.giftPhoneError }}
                        </div>
                    </div>
                    <button 
                        class="checkout-btn" 
                        @click="submitOrder"
                        :disabled="!isFormValid || cart.length === 0">
                        <i class="fas fa-check-circle"></i> Complete Order (AED {{ totalPrice }})
                    </button>
                </div>

                <div v-if="orderSubmitted" class="success-message">
                    <i class="fas fa-check-circle"></i> Order submitted successfully! Thank you for your purchase.
                </div>
            </div>
            <div v-else class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <h3>Your cart is empty</h3>
                <p>Add some lessons to get started!</p>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            data() {
                return {
                    lessons: [], // Empty - will fetch from backend
                    cart: [],
                    showCart: false,
                    sortBy: 'subject',
                    sortOrder: 'asc',
                    searchQuery: '',
                    filteredLessons: [],
                    checkoutForm: {
                        firstName: '',
                        lastName: '',
                        address: '',
                        city: '',
                        state: '',
                        zip: '',
                        sendGift: false,
                        giftPhone: '',
                        phone: '',
                        firstNameError: '',
                        lastNameError: '',
                        phoneError: '',
                        giftPhoneError: ''
                    },
                    orderSubmitted: false
                };
            },
            mounted() {
                // Fetch lessons from backend
                fetch('https://cst3114-full-stack-software-app.onrender.com/lessons')
                    .then(response => response.json())
                    .then(data => {
                        this.lessons = data.map(lesson => ({
                            ...lesson,
                            id: lesson._id, // MongoDB uses _id
                            imageMissing: true
                        }));
                        // Preload images
                        this.lessons.forEach(lesson => {
                            const img = new Image();
                            img.onload = () => this.$set(lesson, 'imageMissing', false);
                            img.src = this.getImagePath(lesson.subject);
                        });
                    })
                    .catch(err => console.error('Error fetching lessons:', err));
            },
            computed: {
                sortedLessons() {
                    let lessons = this.searchQuery ? this.filteredLessons : this.lessons;

                    return [...lessons].sort((a, b) => {
                        let aVal = a[this.sortBy];
                        let bVal = b[this.sortBy];

                        // Convert to numbers for numeric comparison
                        if (this.sortBy === 'price' || this.sortBy === 'spaces') {
                            aVal = Number(aVal);
                            bVal = Number(bVal);
                        } else {
                            // Convert to lowercase for string comparison
                            aVal = String(aVal).toLowerCase();
                            bVal = String(bVal).toLowerCase();
                        }

                        if (this.sortOrder === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                },
                 cartItemCount() {
                    return this.cart.reduce((total, item) => total + item.quantity, 0);
                },
                totalPrice() {
                    return this.cart.reduce((total, item) => total + (item.price * item.quantity), 0).toFixed(2);
                },
                isFormValid() {
                    // Basic required checks: first & last name and buyer phone.
                    const baseValid = this.checkoutForm.firstName &&
                                      this.checkoutForm.lastName &&
                                      this.checkoutForm.phone &&
                                      !this.checkoutForm.firstNameError &&
                                      !this.checkoutForm.lastNameError &&
                                      !this.checkoutForm.phoneError;

                    // If sending as gift, require gift phone and no error
                    if (this.checkoutForm.sendGift) {
                        return baseValid && this.checkoutForm.giftPhone && !this.checkoutForm.giftPhoneError;
                    }

                    return baseValid;
                }
            },
            methods: {
                addToCart(lesson) {
                    if (lesson.spaces > 0) {
                        // Check if lesson already in cart
                        const existingItem = this.cart.find(item => item.id === lesson.id);

                        if (existingItem) {
                            existingItem.quantity++;
                        } else {
                            this.cart.push({
                                id: lesson.id,
                                subject: lesson.subject,
                                location: lesson.location,
                                price: lesson.price,
                                quantity: 1,
                                icon: lesson.icon,
                                // copy the preloaded flag from the lesson (if available)
                                imageMissing: !!lesson.imageMissing
                            });
                        }

                        // Decrease available spaces
                        lesson.spaces--;
                    }
                },
                removeFromCart(item) {
                    const cartIndex = this.cart.findIndex(i => i.id === item.id);
                    if (cartIndex !== -1) {
                        // Return spaces to lesson
                        const lesson = this.lessons.find(l => l.id === item.id);
                        if (lesson) {
                            lesson.spaces += item.quantity;
                        }

                        // Remove from cart
                        this.cart.splice(cartIndex, 1);
                    }
                },
                 toggleCart() {
                    this.showCart = !this.showCart;
                    this.orderSubmitted = false;
                },
                validateForm() {
                    // Validate first name and last name (letters only, including spaces)
                    const nameRegex = /^[a-zA-Z\s]+$/;
                    if (this.checkoutForm.firstName && !nameRegex.test(this.checkoutForm.firstName)) {
                        this.checkoutForm.firstNameError = 'First name must contain letters only';
                    } else {
                        this.checkoutForm.firstNameError = '';
                    }

                    if (this.checkoutForm.lastName && !nameRegex.test(this.checkoutForm.lastName)) {
                        this.checkoutForm.lastNameError = 'Last name must contain letters only';
                    } else {
                        this.checkoutForm.lastNameError = '';
                    }

                    // Validate buyer phone (numbers only)
                    const phoneRegex = /^[0-9]+$/;
                    if (this.checkoutForm.phone && !phoneRegex.test(this.checkoutForm.phone)) {
                        this.checkoutForm.phoneError = 'Phone must contain numbers only';
                    } else {
                        this.checkoutForm.phoneError = '';
                    }

                    // If sendGift is checked, validate giftPhone
                    if (this.checkoutForm.sendGift) {
                        if (this.checkoutForm.giftPhone && !phoneRegex.test(this.checkoutForm.giftPhone)) {
                            this.checkoutForm.giftPhoneError = 'Gift phone must contain numbers only';
                        } else {
                            this.checkoutForm.giftPhoneError = '';
                        }
                    } else {
                        this.checkoutForm.giftPhoneError = '';
                    }
                },
                  submitOrder() {
                    if (!this.isFormValid) return;

                    // Send order to backend
                    fetch('https://cst3114-full-stack-software-app.onrender.com/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            firstName: this.checkoutForm.firstName,
                            lastName: this.checkoutForm.lastName,
                            address: this.checkoutForm.address,
                            city: this.checkoutForm.city,
                            state: this.checkoutForm.state,
                            zip: this.checkoutForm.zip,
                            phone: this.checkoutForm.phone,
                            sendGift: this.checkoutForm.sendGift,
                            giftPhone: this.checkoutForm.giftPhone,
                            cart: this.cart
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Order created:', data);
                        this.orderSubmitted = true;
                        
                        // Clear cart and form after 3 seconds
                        setTimeout(() => {
                            this.cart = [];
                            this.checkoutForm = {
                                firstName: '',
                                lastName: '',
                                address: '',
                                city: '',
                                state: '',
                                zip: '',
                                sendGift: false,
                                giftPhone: '',
                                phone: '',
                                firstNameError: '',
                                lastNameError: '',
                                phoneError: '',
                                giftPhoneError: ''
                            };
                            this.orderSubmitted = false;
                            this.showCart = false;
                        }, 3000);
                    })
                    .catch(err => console.error('Error creating order:', err));
                },
                performSearch() {
                    if (!this.searchQuery.trim()) {
                        this.filteredLessons = [];
                        return;
                    } 

                     // Frontend search
                    const query = this.searchQuery.toLowerCase();
                    this.filteredLessons = this.lessons.filter(lesson => {
                        return lesson.subject.toLowerCase().includes(query) ||
                               lesson.location.toLowerCase().includes(query) ||
                               String(lesson.price).includes(query) ||
                               String(lesson.spaces).includes(query);
                    });
                }
                ,
                // Returns a normalized image path for a given subject.
                // Example: "Computer Science" -> "https://cst3114-full-stack-software-app.onrender.com/images/computer-science.png"
                getImagePath(subject) {
                    const fileName = String(subject)
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/(^-|-$)/g, '');

                    return `https://cst3114-full-stack-software-app.onrender.com/images/${fileName}.png`;
                },
                // When an image fails to load, mark the lesson so the template
                // will render the original Font Awesome icon as a fallback.
                onImgError(event, lesson) {
                    // Create a reactive property imageMissing for the lesson
                    // so v-if will switch to the fallback icon.
                    this.$set(lesson, 'imageMissing', true);
                    try { event.target.style.display = 'none'; } catch (e) {}
                }
                ,
                // Cart image error handler - mark the cart item to use icon fallback
                onCartImgError(event, item) {
                    this.$set(item, 'imageMissing', true);
                    try { event.target.style.display = 'none'; } catch (e) {}
                }
            }
        }).$mount('#app');
        
    </script>
</body>
</html>
        

